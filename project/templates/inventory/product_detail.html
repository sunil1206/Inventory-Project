{% extends "inventory/base.html" %}

{% block title %}{{ product.name }}{% endblock %}
{% block header %}Product Details{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="mb-6">
        <a href="{% url 'inventory:product_list' supermarket.id %}" class="text-sm font-semibold text-blue-600 hover:underline">
            <i class="fas fa-arrow-left mr-2"></i>Back to Product Catalog
        </a>
    </div>

    <div id="main-status-container" class="fixed top-24 right-6 z-[100] w-full max-w-sm"></div>
    {% include 'includes/alerts.html' %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-sm h-fit">
            <img src="{{ product.display_image_url }}" alt="{{ product.name }}" class="w-full h-64 object-contain mb-6 rounded-md border bg-gray-50">

            <h1 class="text-3xl font-bold text-gray-800">{{ product.name }}</h1>
            <p class="text-lg text-gray-500 mb-4">{{ product.brand|default:'No Brand' }}</p>

            <div class="space-y-3 text-sm text-gray-700 mb-6 border-t pt-4">
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-500">Barcode:</span>
                    <span class="font-mono">{{ product.barcode }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-500">Package Size:</span>
                    <span class="font-medium">{{ product.quantity|default:'N/A' }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-500">Nutri-Score:</span>
                    <span classs="font-medium">{{ product.nutriscore_grade|upper|default:'N/A' }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-semibold text-gray-500">Category:</span>
                    <span class="font-medium">
                        {% if product.category %}
                            {{ product.category.name }}
                        {% else %}
                            <span class="text-gray-400 italic">N/A</span>
                        {% endif %}
                    </span>
                </div>
                <div>
                    <span class="font-semibold text-gray-500">Suppliers:</span>
                    <ul class="list-disc list-inside mt-1 ml-1">
                        {% for supplier in product.suppliers.all %}
                            <li class="text-gray-700">{{ supplier.name }}</li>
                        {% empty %}
                            <li class="text-gray-400 italic">No suppliers linked.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <p class="text-gray-700 leading-relaxed">{{ product.description|default:'No description available.'|linebreaksbr }}</p>

            {% if user.is_superadmin %}
            <div class="border-t mt-6 pt-6 flex items-center space-x-3">
                <a href="{% url 'inventory:edit_product' supermarket.id product.barcode %}" class="flex-1 text-center px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition-colors">
                    <i class="fas fa-pencil-alt mr-2"></i>Edit Product
                </a>
                <a href="{% url 'inventory:delete_product' supermarket.id product.barcode %}" class="flex-1 text-center px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors">
                    <i class="fas fa-trash mr-2"></i>Delete
                </a>
            </div>
            {% endif %}
        </div>

        <div class="lg:col-span-2 space-y-8">
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Add to Inventory</h2>
                <p class="text-gray-600 mb-4">Add a new batch of this product to your supermarket's inventory.</p>
                <button id="add-to-inventory-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-md hover:bg-green-600 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add New Batch
                </button>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">In-Stock at {{ supermarket.name }}</h2>

                {% if inventory_items %}
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                                <tr>
                                    <th class="px-4 py-3">Quantity</th>
                                    <th class="px-4 py-3">Expiry Date</th>
                                    <th class="px-4 py-3">Location (Rack)</th>
                                    <th class="px-4 py-3">Batch Price</th>
                                    <th class="px-4 py-3">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in inventory_items %}
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-4 py-3 font-medium">{{ item.quantity }}</td>
                                    <td class="px-4 py-3">{{ item.expiry_date|date:"Y-m-d" }}</td>
                                    <td class="px-4 py-3">
                                        {% if item.rack %}
                                            {{ item.rack.name }}
                                        {% else %}
                                            <span class="text-gray-400 italic">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3">€{{ item.store_price|floatformat:2|default:'--' }}</td>

                                    <td class="px-4 py-3 text-center">
                                        <div class="flex justify-center gap-4">
                                            <a href="{% url 'inventory:edit_inventory_item' supermarket.id item.id %}" class="text-blue-600 hover:text-blue-900" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form action="{% url 'inventory:delete_inventory_item' supermarket.id item.id %}" method="POST" onsubmit="return confirm('Are you sure you want to delete this batch?');">
                                                {% csrf_token %}
                                                <!-- This hidden input is crucial for redirecting back to this page -->
                                                <input type="hidden" name="next" value="product_detail">
                                                <input type="hidden" name="product_barcode" value="{{ product.barcode }}">
                                                <button type="submit" class="text-red-600 hover:text-red-900" title="Delete">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>

                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-8 bg-gray-50 rounded-md">
                        <i class="fas fa-box-open fa-3x text-gray-300 mb-4"></i>
                        <p class="text-gray-500 font-semibold">This product is not currently in your inventory.</p>
                        <p class="text-sm text-gray-400">Click the button above to add the first batch.</p>
                    </div>
                {% endif %}
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Competitor Pricing</h2>

                {% if competitor_prices %}
                    <ul class="space-y-3">
                        {% for price in competitor_prices %}
                        <li class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                            <span class="font-semibold text-gray-700">{{ price.competitor_name }}</span>
                            <span class="font-bold text-green-600 text-lg">€{{ price.price|floatformat:2 }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-center py-8 bg-gray-50 rounded-md">
                        <i class="fas fa-dollar-sign fa-3x text-gray-300 mb-4"></i>
                        <p class="text-gray-500 font-semibold">No competitor price data available.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div id="add-inventory-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-2xl leading-6 font-bold text-gray-900 mb-2" id="modal-product-name">Add Product</h3>
            <div class="text-center mb-4">
                <img id="modal-product-image" src="https://placehold.co/200x200?text=Product" alt="Product Image" class="w-32 h-32 object-contain mx-auto rounded-md border bg-white">
            </div>
            <div class="mt-2 px-7 py-3">
                <form id="add-inventory-form" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="space-y-4 text-left">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="id_quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                                <input type="number" name="quantity" value="1" min="1" id="id_quantity" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="id_expiry_date" class="block text-sm font-medium text-gray-700">Expiry Date</label>
                                <input type="date" name="expiry_date" id="id_expiry_date" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div>
                            <label for="id_manufacture_date" class="block text-sm font-medium text-gray-700">Manufacture Date (Optional)</label>
                            <input type="date" name="manufacture_date" id="id_manufacture_date" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="id_store_price" class="block text-sm font-medium text-gray-700">Store Price (€) (Optional)</label>
                            <input type="number" step="0.01" name="store_price" id="id_store_price" placeholder="Auto-fills from price list" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="id_rack" class="block text-sm font-medium text-gray-700">Rack / Location (Optional)</label>
                            <select name="rack_id" id="id_rack" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                <option value="">---------</option>
                                {% for rack in racks %}
                                    <option value="{{ rack.id }}">{{ rack.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                         <div>
                            <label for="id_category" class="block text-sm font-medium text-gray-700">Category (Optional)</label>
                            <select name="category_id" id="id_category" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4 mt-6">
                        <button id="cancel-btn" type="button" onclick="closeAddModal()" class="w-full px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300">Cancel</button>
                        <button id="ok-btn" type="submit" class="w-full px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700">Add Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // This is the same JS from product_list.html
    // It controls the "Add to Inventory" modal.

    const supermarketId = {{ supermarket.id }};
    const csrfToken = '{{ csrf_token }}';
    const addModal = document.getElementById('add-inventory-modal');
    const addForm = document.getElementById('add-inventory-form');
    const modalProductName = document.getElementById('modal-product-name');
    const modalProductImage = document.getElementById('modal-product-image');
    const modalCategorySelect = document.getElementById('id_category');
    const modalStorePriceInput = document.getElementById('id_store_price');
    const modalRackSelect = document.getElementById('id_rack'); // Get rack select
    const mainStatusContainer = document.getElementById('main-status-container');

    // The barcode is fixed on this page
    const productBarcode = '{{ product.barcode }}';

    // Set the form's action URL
    addForm.action = "{% url 'inventory:add_from_product_list' supermarket.id product.barcode %}";

    // --- Alert Banners ---
    function showMainAlert(title, details, type = 'info') {
        const colors = {
            info: { border: 'border-blue-500', bg: 'bg-blue-100', text: 'text-blue-700' },
            success: { border: 'border-green-500', bg: 'bg-green-100', text: 'text-green-700' },
            error: { border: 'border-red-500', bg: 'bg-red-100', text: 'text-red-700' }
        };
        const alertHtml = `<div class="p-4 mb-4 rounded-lg shadow-lg ${colors[type].bg} ${colors[type].border} ${colors[type].text} border-l-4" role="alert">
            <p class="font-bold">${title}</p>
            <p>${details}</p>
        </div>`;
        mainStatusContainer.innerHTML = alertHtml;
        setTimeout(() => mainStatusContainer.innerHTML = '', 5000);
    }

    // --- Modal Controller ---
    window.openAddModal = function(product, categories) {
        modalProductName.textContent = `Add "${product.name}"`;
        modalProductImage.src = product.image_url || 'https://placehold.co/200x200?text=No+Image';

        // Populate categories
        let categoryOptions = categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
        modalCategorySelect.innerHTML = `<option value="">---------</option>${categoryOptions}`;

        // Auto-fill all default fields
        if (product.default_store_price) {
            modalStorePriceInput.value = product.default_store_price;
        } else {
            modalStorePriceInput.value = '';
        }
        if (product.category_id) {
            modalCategorySelect.value = product.category_id;
        } else {
            modalCategorySelect.value = "";
        }
        if (product.default_rack_id) {
            modalRackSelect.value = product.default_rack_id;
        } else {
            modalRackSelect.value = "";
        }

        // Set smart defaults for dates
        const expiryDateInput = document.getElementById('id_expiry_date');
        const quantityInput = document.getElementById('id_quantity');
        const today = new Date().toISOString().split('T')[0];
        expiryDateInput.setAttribute('min', today);

        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        expiryDateInput.value = nextWeek.toISOString().split('T')[0];

        addModal.classList.remove('hidden');
        setTimeout(() => quantityInput.focus(), 100);
    }

    window.closeAddModal = function() {
        addModal.classList.add('hidden');
        addForm.reset();
    }

    // --- API Lookup ---
    window.lookupAndOpenModal = async function() {
        showMainAlert('Loading...', 'Fetching product defaults...', 'info');
        try {
            const response = await fetch(`{% url 'inventory:scan_api' %}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ barcode: productBarcode, supermarket_id: supermarketId, mode: 'lookup' })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Product not found');
            mainStatusContainer.innerHTML = '';

            // Call the modal function with all the data
            openAddModal(data.product, data.categories);

        } catch (error) {
            showMainAlert('Error', error.message, 'error');
        }
    }

    // --- Event Listeners ---
    document.getElementById('add-to-inventory-btn').addEventListener('click', lookupAndOpenModal);
    window.onclick = function(event) {
        if (event.target == addModal) closeAddModal();
    }
});
</script>
{% endblock %}