{% extends "inventory/base.html" %}
{% load static %}

{% block title %}Alert Monitor{% endblock %}
{% block header %}Urgent Items - {{ supermarket.name }}{% endblock %}

{% block content %}

<div class="mb-6">
    {% include 'includes/alerts.html' %}
</div>

<!-- ================= FILTERS ================= -->
<div class="mb-6 p-4 bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700">Filter by Category</label>
            <select id="filter-category" class="mt-1 block w-full p-2 border rounded-md">
                <option value="all">All Categories</option>
                {% for category in available_categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700">Filter by Rack</label>
            <select id="filter-rack" class="mt-1 block w-full p-2 border rounded-md">
                <option value="all">All Racks</option>
                {% for rack in available_racks %}
                <option value="{{ rack.id }}">{{ rack.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700">Filter by Expiry Date</label>
            <input type="date" id="filter-date" class="mt-1 block w-full p-2 border rounded-md">
        </div>

        <div class="md:mt-6">
            <button id="clear-filters-btn" class="w-full px-4 py-2 bg-gray-600 text-white rounded-md">
                Clear Filters
            </button>
        </div>
    </div>
</div>

<!-- ================= EXPIRED ================= -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<div class="bg-red-50 p-4 rounded-lg shadow-sm">
<h2 class="font-bold text-lg text-red-800 mb-4">
Expired (<span id="expired-count">{{ expired_items|length }}</span>)
</h2>

<div id="expired-list" class="space-y-4">
{% for item in expired_items %}
<div class="item-card bg-white p-4 rounded"
     data-category-id="{{ item.get_category.id }}"
     data-rack="{{ item.rack.id }}"
     data-expiry-date="{{ item.expiry_date|date:'Y-m-d' }}">

<p class="font-bold">{{ item.product.name }}</p>
<p class="text-sm text-gray-500">Qty: {{ item.quantity }}</p>

<div class="mt-3 flex justify-end gap-2">
<button onclick="openWastageModal({{ item.id }})"
        class="px-3 py-1 bg-gray-300 rounded">Wastage</button>

<button onclick="openSellModal({{ item.id }})"
        class="px-3 py-1 bg-blue-600 text-white rounded">Sell</button>
</div>
</div>
{% empty %}
<p id="no-expired-msg">No expired items</p>
{% endfor %}
</div>
</div>
</div>

<!-- ================= SELL MODAL ================= -->
<div id="sell-modal" class="fixed inset-0 hidden bg-black/50 z-50">
<div class="bg-white max-w-lg mx-auto mt-20 p-5 rounded">

<form id="sell-form" method="POST">
{% csrf_token %}

<h3 class="text-xl font-bold mb-3">Sell / Manage Item</h3>

<p>
<strong id="modal-item-name"></strong> —
Qty: <strong id="modal-item-quantity"></strong>
</p>

<input id="modal-quantity-sold" name="quantity_sold" type="number"
       class="w-full p-2 border mt-2" min="1">

<input id="modal-original-price" disabled
       class="w-full p-2 border mt-2 bg-gray-100">

<input id="modal-final-price" name="final_price" step="0.01"
       class="w-full p-2 border mt-2">

<select id="modal-discount-select" class="w-full p-2 border mt-2">
<option value="">No Discount</option>
{% for rule in active_rules %}
<option value="rule-{{ rule.id }}">{{ rule.name }}</option>
{% endfor %}
{% for promo in active_promotions %}
<option value="promotion-{{ promo.id }}">{{ promo.name }}</option>
{% endfor %}
</select>

<input type="hidden" id="modal-discount-type" name="discount_type">
<input type="hidden" id="modal-discount-id" name="discount_id">

<div class="mt-4 flex justify-end gap-2">
<button type="button" onclick="closeSellModal()">Cancel</button>
<button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">
Save
</button>
</div>

</form>
</div>
</div>

<!-- ================= WASTAGE MODAL ================= -->
<div id="wastage-modal" class="fixed inset-0 hidden bg-black/50 z-50">
<div class="bg-white max-w-lg mx-auto mt-20 p-5 rounded">

<form id="wastage-form" method="POST">
{% csrf_token %}

<h3 class="text-xl font-bold mb-3">Remove Wastage</h3>

<p>
<strong id="wastage-modal-name"></strong> —
Qty: <strong id="wastage-modal-quantity"></strong>
</p>

<input id="modal-quantity-wasted" name="quantity_wasted" type="number"
       class="w-full p-2 border mt-2" min="1">

<div class="mt-4 flex justify-end gap-2">
<button type="button" onclick="closeWastageModal()">Cancel</button>
<button type="submit" class="bg-red-600 text-white px-4 py-2 rounded">
Save
</button>
</div>

</form>
</div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {

const sellModal = document.getElementById("sell-modal");
const wastageModal = document.getElementById("wastage-modal");
const discountSelect = document.getElementById("modal-discount-select");

const filterCategory = document.getElementById("filter-category");
const filterRack = document.getElementById("filter-rack");
const filterDate = document.getElementById("filter-date");
const clearFiltersBtn = document.getElementById("clear-filters-btn");

const allItems = {
{% for item in expired_items %}
"{{ item.id }}": {
id: {{ item.id }},
name: "{{ item.product.name|escapejs }}",
quantity: {{ item.quantity }},
store_price: "{{ item.store_price|stringformat:'.2f' }}",
suggested_price: "{{ item.suggested_price|stringformat:'.2f' }}",
promotion_id: "{{ item.promotion.id|default:'' }}",
applied_rule_id: "{{ item.applied_rule.id|default:'' }}"
},
{% endfor %}
};

let currentItem = null;

window.openSellModal = function (id) {
currentItem = allItems[id];
if (!currentItem) return;

document.getElementById("modal-item-name").textContent = currentItem.name;
document.getElementById("modal-item-quantity").textContent = currentItem.quantity;
document.getElementById("modal-original-price").value = currentItem.store_price;
document.getElementById("modal-final-price").value = currentItem.suggested_price;

if (currentItem.applied_rule_id) {
discountSelect.value = `rule-${currentItem.applied_rule_id}`;
} else if (currentItem.promotion_id) {
discountSelect.value = `promotion-${currentItem.promotion_id}`;
} else {
discountSelect.value = "";
}

sellModal.classList.remove("hidden");
};

window.closeSellModal = () => sellModal.classList.add("hidden");

window.openWastageModal = function (id) {
currentItem = allItems[id];
document.getElementById("wastage-modal-name").textContent = currentItem.name;
document.getElementById("wastage-modal-quantity").textContent = currentItem.quantity;
wastageModal.classList.remove("hidden");
};

window.closeWastageModal = () => wastageModal.classList.add("hidden");

/* ================= FILTER LOGIC ================= */
function applyFilters() {
document.querySelectorAll(".item-card").forEach(card => {
const matchCategory = filterCategory.value === "all" || card.dataset.categoryId === filterCategory.value;
const matchRack = filterRack.value === "all" || card.dataset.rack === filterRack.value;
const matchDate = !filterDate.value || card.dataset.expiryDate === filterDate.value;

card.classList.toggle("hidden", !(matchCategory && matchRack && matchDate));
});
}

filterCategory.addEventListener("change", applyFilters);
filterRack.addEventListener("change", applyFilters);
filterDate.addEventListener("change", applyFilters);

clearFiltersBtn.addEventListener("click", () => {
filterCategory.value = "all";
filterRack.value = "all";
filterDate.value = "";
applyFilters();
});

});
</script>
{% endblock %}
