{% extends "inventory/base.html" %}

{% block title %}Find Product{% endblock %}
{% block header %}Find Product{% endblock %}

{% block content %}
<style>
    #reader video {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover;
    }
</style>

<div class="max-w-2xl mx-auto">
    {% include 'includes/alerts.html' %}

    <div class="bg-white p-6 rounded-2xl shadow-lg">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">Find or Create Product</h1>
        <p class="text-gray-600 mb-6">Scan a barcode or enter it manually. The system will either find the existing product or help you create a new one.</p>

        <div class_name="mb-4 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-scan" class="tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Scan with Camera
                </button>
                <button id="tab-manual" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Enter Manually
                </button>
            </nav>
        </div>

        <form id="barcode-form">
    {% csrf_token %}

    <div id="pane-manual">
        <label class="block text-sm font-medium text-gray-700">Barcode</label>
        <input type="text" id="manual-barcode"
               class="mt-1 block w-full p-3 border rounded-md focus:ring-blue-500 focus:border-blue-500"
               placeholder="Type barcode here...">

        <!-- ✅ ID ADDED -->
        <button id="manual-submit" type="button"
                class="mt-4 w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">
            Find Product
        </button>
    </div>

    <div id="pane-scan" class="hidden">
        <div id="reader" class="w-full h-80 bg-gray-900 rounded-lg overflow-hidden"></div>
        <p id="scanner-status"
           class="mt-2 text-center text-gray-500 text-sm">
           Initializing camera...
        </p>
    </div>
</form>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {

    const tabScan = document.getElementById("tab-scan");
    const tabManual = document.getElementById("tab-manual");
    const paneScan = document.getElementById("pane-scan");
    const paneManual = document.getElementById("pane-manual");
    const manualInput = document.getElementById("manual-barcode");
    const manualBtn = document.getElementById("manual-submit");
    const status = document.getElementById("scanner-status");

    let html5QrCode;
    let scanLocked = false;   // ✅ prevents double scan

    function activate(tab) {
        if (tab === "scan") {
            paneScan.classList.remove("hidden");
            paneManual.classList.add("hidden");
            startScanner();
        } else {
            paneManual.classList.remove("hidden");
            paneScan.classList.add("hidden");
            stopScanner();
        }
    }

    tabScan.onclick = () => activate("scan");
    tabManual.onclick = () => activate("manual");

    // ✅ FIXED API CALL
    function lookupBarcode(barcode) {
        fetch("{% url 'inventory:scan_api' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
                "Authorization": "Bearer {{ request.user.auth_token.key }}"
            },
            body: JSON.stringify({
                mode: "lookup",
                barcode: barcode,
                supermarket_id: "{{ supermarket.id }}"
            })
        })
        .then(res => {
            if (!res.ok) throw new Error("API failed");
            return res.json();
        })
        .then(data => {
            if (data.product) {
                window.location.href =
                    `/inventory/add/{{ supermarket.id }}/?barcode=${data.product.barcode}`;
            }
        })
        .catch(err => {
            console.error(err);
            alert("Scan failed");
            scanLocked = false;
        });
    }

    // MANUAL
    manualBtn.onclick = () => {
        if (!manualInput.value) return;
        lookupBarcode(manualInput.value);
    };

    // SCAN
    function onScanSuccess(text) {
        if (scanLocked) return;
        scanLocked = true;

        status.innerHTML = `<b class="text-green-600">Found: ${text}</b>`;
        stopScanner();
        lookupBarcode(text);
    }

    function startScanner() {
        if (html5QrCode?.isScanning) return;

        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            onScanSuccess
        ).then(() => {
            status.innerText = "Scanner active";
        }).catch(err => {
            status.innerText = "Camera error";
            console.error(err);
        });
    }

    function stopScanner() {
        if (html5QrCode?.isScanning) {
            html5QrCode.stop();
        }
    }

    activate("manual");
});
</script>

{% endblock %}