{% extends "inventory/base.html" %}

{% block title %}Find Product{% endblock %}
{% block header %}Find Product{% endblock %}

{% block content %}
<style>
    #reader video {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover;
    }
</style>

<div class="max-w-2xl mx-auto">
    {% include 'includes/alerts.html' %}

    <div class="bg-white p-6 rounded-2xl shadow-lg">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">Find or Create Product</h1>
        <p class="text-gray-600 mb-6">Scan a barcode or enter it manually. The system will either find the existing product or help you create a new one.</p>

        <div class_name="mb-4 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-scan" class="tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Scan with Camera
                </button>
                <button id="tab-manual" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Enter Manually
                </button>
            </nav>
        </div>

        <form id="barcode-form" action="{% url 'inventory:scan_redirect' supermarket.id %}" method="POST">
            {% csrf_token %}

            <div id="pane-manual">
                <label for="manual-barcode" class="block text-sm font-medium text-gray-700">Barcode</label>
                <input type="text" name="barcode" id="manual-barcode" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Type barcode here...">
                <button type="submit" class="mt-4 w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700">
                    Find Product
                </button>
            </div>

            <div id="pane-scan" class="hidden">
                <div id="reader" class="w-full h-80 bg-gray-900 rounded-lg overflow-hidden"></div>
                <p id="scanner-status" class="mt-2 text-center text-gray-500 text-sm">Initializing camera...</p>
                <input type="hidden" name="barcode" id="scanned-barcode">
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabScan = document.getElementById('tab-scan');
    const tabManual = document.getElementById('tab-manual');
    const paneScan = document.getElementById('pane-scan');
    const paneManual = document.getElementById('pane-manual');
    const barcodeForm = document.getElementById('barcode-form');
    const manualBarcode = document.getElementById('manual-barcode');
    const scannedBarcode = document.getElementById('scanned-barcode');
    const scannerStatus = document.getElementById('scanner-status');
    let html5QrCode;

    function activateTab(tab) {
        if (tab === 'scan') {
            // Activate Scan Tab
            tabScan.classList.add('border-blue-500', 'text-blue-600');
            tabScan.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            paneScan.classList.remove('hidden');
            // Deactivate Manual Tab
            tabManual.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            tabManual.classList.remove('border-blue-500', 'text-blue-600');
            paneManual.classList.add('hidden');
            // Enable/disable form fields
            manualBarcode.disabled = true;
            scannedBarcode.disabled = false;
            startScanner();
        } else {
            // Activate Manual Tab
            tabManual.classList.add('border-blue-500', 'text-blue-600');
            tabManual.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            paneManual.classList.remove('hidden');
            // Deactivate Scan Tab
            tabScan.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            tabScan.classList.remove('border-blue-500', 'text-blue-600');
            paneScan.classList.add('hidden');
            // Enable/disable form fields
            manualBarcode.disabled = false;
            scannedBarcode.disabled = true;
            stopScanner();
        }
    }

    tabScan.addEventListener('click', () => activateTab('scan'));
    tabManual.addEventListener('click', () => activateTab('manual'));

    // --- Scanner Logic ---
    function onScanSuccess(decodedText, decodedResult) {
        scannerStatus.innerHTML = `<p class="text-green-600 font-bold">âœ… Success! Found: ${decodedText}</p>`;
        stopScanner();
        // Fill the hidden form field and submit
        scannedBarcode.value = decodedText;
        barcodeForm.submit();
    }

    async function startScanner() {
        if (html5QrCode && html5QrCode.isScanning) return;
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 150 } };
        scannerStatus.textContent = "Requesting camera access...";
        try {
            await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (err) => {});
            scannerStatus.textContent = "Scanner active. Please scan a barcode.";
        } catch (err) {
            scannerStatus.textContent = `Camera Error: ${err}`;
        }
    }

    function stopScanner() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.error("Failed to stop scanner", err));
        }
    }

    // Initialize to manual tab by default
    activateTab('manual');
});
</script>
{% endblock %}