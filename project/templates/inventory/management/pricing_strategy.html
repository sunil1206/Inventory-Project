{% extends "inventory/base.html" %}

{% block title %}Pricing Strategy{% endblock %}
{% block header %}Manage Pricing Strategy for {{ supermarket.name }}{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- List of Current Pricing Rules -->
    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Your Pricing Rules</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3">Priority</th>
                        <th scope="col" class="px-6 py-3">Rule Name</th>
                        <th scope="col" class="px-6 py-3">Condition</th>
                        <th scope="col" class="px-6 py-3">Action</th>
                        <th scope="col" class="px-6 py-3">Applies To</th>
                        <th scope="col" class="px-6 py-3">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rule in rules %}
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-bold text-gray-700">{{ rule.priority }}</td>
                        <td class="px-6 py-4 font-medium text-gray-900">{{ rule.name }}</td>
                        <td class="px-6 py-4">{{ rule.get_rule_type_display }}</td>
                        <td class="px-6 py-4 font-semibold">{{ rule.amount }}%</td>
                        <td class="px-6 py-4 text-xs">
                            {% if rule.category %}
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Cat: {{ rule.category.name }}</span>
                            {% elif rule.supplier %}
                                 <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full">Sup: {{ rule.supplier.name }}</span>
                            {% elif rule.days_until_expiry is not None %}
                                 <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full">Expiry <= {{ rule.days_until_expiry }} days</span>
                            {% else %}
                                <span class="text-gray-500">All Products</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <!-- NOTE: You will need to create a `remove_rule` view and URL for this to work -->
                            <form action="#" method="POST" onsubmit="return confirm('Are you sure you want to delete this rule?');">
                                {% csrf_token %}
                                <button type="submit" class="font-medium text-red-600 hover:underline" title="Delete Rule">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            You have not created any pricing rules yet.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create New Pricing Rule Panel -->
    <div class="bg-white p-6 rounded-lg shadow-lg h-fit">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Create New Rule</h2>
        <form action="{% url 'inventory:pricing_strategy' supermarket.id %}" method="POST" class="space-y-4">
            {% csrf_token %}
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700">Rule Name</label>
                <input type="text" name="name" id="name" required class="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., Beat Dairy Competitors">
            </div>
            <div>
                <label for="rule_type" class="block text-sm font-medium text-gray-700">Rule Type</label>
                <select name="rule_type" id="rule_type" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    <option value="MATCH_LOWEST">Match Lowest Competitor</option>
                    <option value="BEAT_LOWEST">Beat Lowest Competitor by %</option>
                    <option value="PROFIT_MARGIN">Maintain Profit Margin %</option>
                    <option value="EXPIRY_DISCOUNT">Discount by % based on Expiry</option>
                </select>
            </div>
            <div>
                <label for="amount" class="block text-sm font-medium text-gray-700">Percentage Value (%)</label>
                <input type="number" step="0.01" name="amount" id="amount" required class="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., 5 for 5%">
            </div>
            <div class="border-t pt-4">
                <p class="text-sm font-medium text-gray-700 mb-2">Optional Filters</p>
                 <div>
                    <label for="category" class="block text-sm font-medium text-gray-700">Apply to Category</label>
                    <select name="category" id="category" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        <option value="">All Categories</option>
                        <!-- Assuming 'categories' is passed in context -->
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                 <div class="mt-4">
                    <label for="days_until_expiry" class="block text-sm font-medium text-gray-700">Days Until Expiry (for expiry rule)</label>
                    <input type="number" name="days_until_expiry" id="days_until_expiry" class="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., 3">
                </div>
            </div>
             <div>
                <label for="priority" class="block text-sm font-medium text-gray-700">Priority</label>
                <input type="number" name="priority" id="priority" value="100" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                <p class="text-xs text-gray-500 mt-1">Lower number runs first.</p>
            </div>
            <div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-plus"></i> Add Rule
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
