{% extends "inventory/base.html" %}
{% load static %}

{% block title %}Analytics Dashboard{% endblock %}
{% block header %}Analytics Overview{% endblock %}

{% block content %}

<!-- ================= KPI CARDS ================= -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">

    <div class="bg-white p-5 rounded-xl shadow">
        <p class="text-gray-500 text-sm">Total Revenue</p>
        <h2 class="text-3xl font-bold text-green-600">
            €{{ total_revenue|floatformat:2 }}
        </h2>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
        <p class="text-gray-500 text-sm">Units Sold</p>
        <h2 class="text-3xl font-bold text-indigo-600">
            {{ total_units_sold }}
        </h2>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
        <p class="text-gray-500 text-sm">Active Pricing Rules</p>
        <h2 class="text-3xl font-bold text-blue-600">
            {{ active_rules }}
        </h2>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
        <p class="text-gray-500 text-sm">Avg Discount</p>
        <h2 class="text-3xl font-bold text-purple-600">
            {{ avg_discount }}%
        </h2>
    </div>
</div>

<!-- ================= CORE ANALYTICS ================= -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

    <div class="bg-white p-5 rounded-xl shadow">
        <h3 class="font-semibold mb-2">Stock Expiry Status</h3>
        <canvas id="expiryChart"></canvas>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
        <h3 class="font-semibold mb-2">Sales Trend (30 Days)</h3>
        <canvas id="salesTrendChart"></canvas>
    </div>

</div>

<!-- ================= CATEGORY & SUPPLIER ================= -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

    <div class="bg-white p-5 rounded-xl shadow">
        <h3 class="font-semibold mb-2">Revenue by Category</h3>
        <canvas id="catChart"></canvas>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
        <h3 class="font-semibold mb-2">Top Suppliers (Cartons)</h3>
        <canvas id="supplierChart"></canvas>
    </div>

</div>

<!-- ================= PRICING & PROMOTIONS ================= -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

    <div class="bg-white p-5 rounded-xl shadow">
        <h3 class="font-semibold mb-2">Pricing Rule Types</h3>
        <canvas id="ruleChart"></canvas>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
        <h3 class="font-semibold mb-2">Promotion Types</h3>
        <canvas id="promoChart"></canvas>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
        <h3 class="font-semibold mb-2">Discount Impact</h3>
        <canvas id="impactChart"></canvas>
    </div>

</div>

<!-- ================= WASTAGE & STRATEGY (THESIS) ================= -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

    <div class="bg-white p-5 rounded-xl shadow">
        <h3 class="font-semibold mb-2">Wastage Loss by Category</h3>
        <canvas id="wastageCategoryChart"></canvas>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
        <h3 class="font-semibold mb-2">Sales vs Wastage</h3>
        <canvas id="salesVsWastageChart"></canvas>
    </div>

</div>

<!-- ================= CHART.JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const expiryData = {{ expiry_data|safe }};
const catLabels = {{ cat_labels|safe }};
const catValues = {{ cat_values|safe }};
const supplierLabels = {{ supplier_labels|safe }};
const supplierValues = {{ supplier_values|safe }};
const salesTrend = {{ sales_trend|safe }};
const ruleLabels = {{ rule_labels|safe }};
const ruleValues = {{ rule_values|safe }};
const promoLabels = {{ promo_labels|safe }};
const promoValues = {{ promo_values|safe }};
const impactLabels = {{ impact_labels|safe }};
const impactValues = {{ impact_values|safe }};
const wastageCatLabels = {{ wastage_cat_labels|safe }};
const wastageCatValues = {{ wastage_cat_values|safe }};
const salesVsWastage = {{ sales_vs_wastage|safe }};

document.addEventListener("DOMContentLoaded", () => {

    new Chart(expiryChart, {
        type: 'doughnut',
        data: {
            labels: ["Expired", "Expiring", "Fresh"],
            datasets: [{ data: expiryData }]
        }
    });

    new Chart(salesTrendChart, {
        type: 'line',
        data: {
            labels: salesTrend.labels,
            datasets: [{ label: "Revenue (€)", data: salesTrend.values }]
        }
    });

    new Chart(catChart, {
        type: 'bar',
        data: { labels: catLabels, datasets: [{ data: catValues }] },
        options: { indexAxis: 'y' }
    });

    new Chart(supplierChart, {
        type: 'bar',
        data: { labels: supplierLabels, datasets: [{ data: supplierValues }] }
    });

    new Chart(ruleChart, {
        type: 'doughnut',
        data: { labels: ruleLabels, datasets: [{ data: ruleValues }] }
    });

    new Chart(promoChart, {
        type: 'polarArea',
        data: { labels: promoLabels, datasets: [{ data: promoValues }] }
    });

    new Chart(impactChart, {
        type: 'pie',
        data: { labels: impactLabels, datasets: [{ data: impactValues }] }
    });

    new Chart(wastageCategoryChart, {
        type: 'bar',
        data: {
            labels: wastageCatLabels,
            datasets: [{ label: "Loss (€)", data: wastageCatValues }]
        }
    });

    new Chart(salesVsWastageChart, {
        type: 'radar',
        data: {
            labels: ["Revenue", "Wastage Loss"],
            datasets: [{ data: salesVsWastage }]
        }
    });

});
</script>

{% endblock %}
