{% extends "inventory/base.html" %}

{% block title %}AI Expiry Suggestions{% endblock %}
{% block header %}AI-Assisted Expiry Suggestions {% endblock %}

{% block content %}

<p class="text-sm text-gray-600 mb-6">
    AI-assisted expiry suggestions based on inventory data across all stores.
    These are recommendations only — not automated actions.
</p>

<!-- ================= FILTERS ================= -->
<div class="bg-white p-4 rounded-lg shadow border mb-8">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">

        <div>
            <label class="text-sm font-medium text-gray-700">Category</label>
            <select id="filter-category" class="mt-1 w-full p-2 border rounded-md">
                <option value="all">All Categories</option>
                {% for category in available_categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="text-sm font-medium text-gray-700">From Date</label>
            <input type="date" id="filter-from" class="mt-1 w-full p-2 border rounded-md">
        </div>

        <div>
            <label class="text-sm font-medium text-gray-700">To Date</label>
            <input type="date" id="filter-to" class="mt-1 w-full p-2 border rounded-md">
        </div>

        <div class="flex items-end">
            <button id="clear-filters"
                    class="w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                Clear Filters
            </button>
        </div>
    </div>
</div>

<!-- ================= VIEW EXPIRED BUTTON ================= -->
<div class="flex justify-end mb-6">
    <a href="{% url 'expiry:expired_products' supermarket.id %}"
       class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm">
        View Expired Products
    </a>
</div>

{% if ai_recommendations %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- ================= EXPIRING TODAY ================= -->
    <div class="bg-orange-50 rounded-lg p-4 shadow-sm">
        <h2 class="font-bold text-lg text-orange-800 mb-4">
            Expiring Today
        </h2>

        <div class="space-y-4 max-h-[70vh] overflow-y-auto">
            {% for rec in ai_recommendations %}
                {% if rec.days_left == 0 %}
                <div class="ai-card bg-white p-3 rounded-lg shadow border"
                     data-category="{{ rec.product.category.id }}"
                     data-expiry="{{ rec.expiry_date|date:'Y-m-d' }}">
                    <img src="{{ rec.product.display_image_url }}"
                         class="h-20 w-full object-contain mb-2">
                    <p class="font-semibold">{{ rec.product.name }}</p>
                    <p class="text-xs text-gray-600">Expires today</p>
                    <p class="text-sm text-gray-600">
    Expiry Date:
    <span class="font-semibold">{{ rec.expiry_date_str }}</span>
</p>

                    <p class="text-xs text-gray-500">
                        Confidence {{ rec.confidence }}%
                        · {{ rec.store_count }} store{{ rec.store_count|pluralize }}
                    </p>

                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- ================= EXPIRING IN 7 DAYS ================= -->
    <div class="bg-yellow-50 rounded-lg p-4 shadow-sm">
        <h2 class="font-bold text-lg text-yellow-800 mb-4">
            Expiring in 7 Days
        </h2>

        <div class="space-y-4 max-h-[70vh] overflow-y-auto">
            {% for rec in ai_recommendations %}
                {% if rec.days_left > 0 and rec.days_left <= 7 %}
                <div class="ai-card bg-white p-3 rounded-lg shadow border"
                     data-category="{{ rec.product.category.id }}"
                     data-expiry="{{ rec.expiry_date|date:'Y-m-d' }}">
                    <img src="{{ rec.product.display_image_url }}"
                         class="h-20 w-full object-contain mb-2">
                    <p class="font-semibold">{{ rec.product.name }}</p>
                    <p class="text-xs text-gray-600">
                        Expires in {{ rec.days_left }} day{{ rec.days_left|pluralize }}
                    </p>
                    <p class="text-sm text-gray-600">
    Expiry Date:
    <span class="font-semibold">{{ rec.expiry_date_str }}</span>
</p>

                    <p class="text-xs text-gray-500">
                        Confidence {{ rec.confidence }}%
                        · {{ rec.store_count }} store{{ rec.store_count|pluralize }}
                    </p>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- ================= EXPIRING IN 30 DAYS ================= -->
    <div class="bg-indigo-50 rounded-lg p-4 shadow-sm">
        <h2 class="font-bold text-lg text-indigo-800 mb-4">
            Expiring in 30 Days
        </h2>

        <div class="space-y-4 max-h-[70vh] overflow-y-auto">
            {% for rec in ai_recommendations %}
                {% if rec.days_left > 7 and rec.days_left <= 30 %}
                <div class="ai-card bg-white p-3 rounded-lg shadow border"
                     data-category="{{ rec.product.category.id }}"
                     data-expiry="{{ rec.expiry_date|date:'Y-m-d' }}">
                    <img src="{{ rec.product.display_image_url }}"
                         class="h-20 w-full object-contain mb-2">
                    <p class="font-semibold">{{ rec.product.name }}</p>
                    <p class="text-xs text-gray-600">
                        Expires in {{ rec.days_left }} days
                    </p>
                    <p class="text-sm text-gray-600">
    Expiry Date:
    <span class="font-semibold">{{ rec.expiry_date_str }}</span>
</p>

                    <p class="text-xs text-gray-500">
                        Confidence {{ rec.confidence }}%
                        · {{ rec.store_count }} store{{ rec.store_count|pluralize }}
                    </p>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

</div>

{% else %}
<div class="bg-white p-8 rounded-lg shadow text-center text-gray-600">
    <i class="fas fa-check-circle text-green-500 text-3xl mb-3"></i>
    <p class="font-semibold">No AI recommendations available</p>
</div>
{% endif %}


{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    const categoryFilter = document.getElementById("filter-category");
    const fromDate = document.getElementById("filter-from");
    const toDate = document.getElementById("filter-to");
    const clearBtn = document.getElementById("clear-filters");

    const cards = document.querySelectorAll(".ai-card");

    function applyFilters() {
        const cat = categoryFilter.value;
        const from = fromDate.value;
        const to = toDate.value;

        cards.forEach(card => {
            const cardCat = card.dataset.category;
            const expiry = card.dataset.expiry;

            let visible = true;

            if (cat !== "all" && cardCat !== cat) visible = false;
            if (from && expiry < from) visible = false;
            if (to && expiry > to) visible = false;

            card.classList.toggle("hidden", !visible);
        });
    }

    categoryFilter.addEventListener("change", applyFilters);
    fromDate.addEventListener("change", applyFilters);
    toDate.addEventListener("change", applyFilters);

    clearBtn.addEventListener("click", () => {
        categoryFilter.value = "all";
        fromDate.value = "";
        toDate.value = "";
        applyFilters();
    });

});
</script>
{% endblock %}
