{% extends "inventory/base.html" %}
{% block title %}Map Carton Packaging{% endblock %}
{% block header %}Packaging · Map Carton{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto space-y-6">
    <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-1">
            Map Carton for: {{ product.name }}
        </h2>
        <p class="text-sm text-gray-600 mb-2">
            Unit barcode (CU): <span class="font-mono">{{ unit_barcode }}</span>
        </p>
        <p class="text-xs text-gray-500">
            Only superadmins can modify packaging here.
        </p>
    </div>

    <div class="bg-white rounded-xl shadow p-6 space-y-4">
        <h3 class="text-sm font-semibold text-gray-700 mb-2">Existing carton configurations</h3>
        {% if existing_packs %}
            <ul class="text-sm text-gray-700 list-disc pl-5 space-y-1 mb-4">
            {% for p in existing_packs %}
                <li>
                    {{ p.units_per_carton }} units · Carton: <span class="font-mono">{{ p.carton_barcode }}</span>
                    {% if p.supplier %} · Supplier: {{ p.supplier.name }}{% endif %}
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p class="text-xs text-gray-500 mb-4">No carton configs yet for this CU.</p>
        {% endif %}

        <h3 class="text-sm font-semibold text-gray-700 mb-2">Add / Update carton config</h3>
        <form id="cartonForm" class="space-y-3">
            {% csrf_token %}
            <input type="hidden" name="unit_barcode" value="{{ unit_barcode }}">

            <div>
                <label class="text-xs font-medium text-gray-600">Carton barcode (DU)</label>
                <input type="text" name="carton_barcode" class="w-full border rounded px-3 py-2 text-sm"
                       placeholder="Scan or type carton code">
            </div>

            <div>
                <label class="text-xs font-medium text-gray-600">Units per carton</label>
                <input type="number" name="units_per_carton" min="1"
                       class="w-full border rounded px-3 py-2 text-sm" placeholder="e.g. 12 or 24">
            </div>

            <div>
                <label class="text-xs font-medium text-gray-600">Supplier (optional)</label>
                <select name="supplier_id" class="w-full border rounded px-3 py-2 text-sm">
                    <option value="">-- None --</option>
                    {% for s in product.suppliers.all %}
                        <option value="{{ s.id }}">{{ s.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit"
                    class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-semibold">
                Save carton mapping
            </button>

            <p id="saveStatus" class="text-xs text-gray-500 mt-2"></p>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
    const form = document.getElementById("cartonForm");
    const status = document.getElementById("saveStatus");

    form.addEventListener("submit", function(e){
        e.preventDefault();
        status.textContent = "Saving…";

        const formData = new FormData(form);

        fetch("{% url 'packaging:save_carton_api' %}", {
            method: "POST",
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                status.textContent = data.message;
                setTimeout(() => window.location.reload(), 600);
            } else {
                status.textContent = data.message || "Error saving.";
            }
        })
        .catch(err => {
            status.textContent = "Error: " + err;
        });
    });
})();
</script>
{% endblock %}
